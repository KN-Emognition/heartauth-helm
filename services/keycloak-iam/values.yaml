# --- keycloak values.yaml (no template changes) ---

replicaCount: 1

image:
  repository: poziomk3/keycloak-iam
  tag: v1.0.0
  pullPolicy: IfNotPresent


# DB connection (chart sets KC_DB/KC_DB_URL_* and creates Secret for user/pass)
database:
  vendor: "postgres"
  host: "postgres"
  port: "5432"
  database: "keycloak"

# Expose HTTP via Service
service:
  type: ClusterIP
  httpPort: 80

# Use the chart’s proxy switch instead of adding KC_PROXY_HEADERS yourself
proxy:
  enabled: true        # sets KC_PROXY_HEADERS for you (default "forwarded")
  # mode: xforwarded    # uncomment if your proxy sends x-forwarded-*

# Health probes (use HTTP port & your /keycloak path)
health:
  enabled: true
  startupProbe: |
    httpGet:
      path: /keycloak/health
      port: http
    initialDelaySeconds: 30
    timeoutSeconds: 1
    failureThreshold: 60
    periodSeconds: 5
  readinessProbe: |
    httpGet:
      path: /keycloak/health/ready
      port: http
    initialDelaySeconds: 30
    timeoutSeconds: 1
  livenessProbe: |
    httpGet:
      path: /keycloak/health/live
      port: http
    initialDelaySeconds: 0
    timeoutSeconds: 5

resources:
  requests:
    cpu: "100m"
    memory: "256Mi"
  limits:
    cpu: "500m"
    memory: "512Mi"

# Everything else that isn’t provided by the chart goes here.
# IMPORTANT: Do NOT duplicate envs that the chart already sets (admin/DB/proxy/health).
extraEnv:
  - name: KEYCLOAK_ADMIN
    value: "admin"
  - name: KEYCLOAK_ADMIN_PASSWORD
    value: "admin"
  - name: KC_HTTP_ENABLED
    value: "true"
  - name: KC_HTTP_RELATIVE_PATH
    value: "/keycloak"
  - name: KC_HOSTNAME_URL
    value: "https://hauth.test.poziomk3.pl/keycloak"
  - name: KC_HOSTNAME_STRICT
    value: "false"
  - name: KC_HOSTNAME_BACKCHANNEL_DYNAMIC
    value: "false"
  - name: KC_LOG_LEVEL
    value: "knemognition.heartauth.authenticators:debug"
  - name: KC_HTTP_MANAGEMENT_RELATIVE_PATH
    value: "/"

  # Optional cluster discovery (safe with 1 replica, useful later)
  - name: JGROUPS_DISCOVERY_PROTOCOL
    value: "dns.DNS_PING"
  - name: JGROUPS_DISCOVERY_PROPERTIES
    value: "dns_query=keycloak-iam-headless.default.svc.cluster.local"
  - name: KC_CACHE
    value: "ispn"
  - name: KC_CACHE_STACK
    value: "kubernetes"
  - name: KC_DB_USERNAME
    value: "keycloak"
  - name: KC_DB_PASSWORD
    value: "PhQ0wq9xL6c0D535TZqn/Uxk58ayXozu3fPzz927p0g="

ingress:
  enabled: true
  className: "traefik"
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt
    traefik.ingress.kubernetes.io/router.entrypoints: web,websecure
  labels: {}
  rules:
    - host: hauth.test.poziomk3.pl
      paths:
        - path: /keycloak
          pathType: Prefix
  tls:
    - secretName: hauth-tls
      hosts:
        - hauth.test.poziomk3.pl