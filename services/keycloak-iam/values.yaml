replicaCount: 1

image:
  repository: poziomk3/keycloak-iam   # your custom image with realm baked in
  tag: v1.0.0
  pullPolicy: IfNotPresent

admin:
  user: admin
  # If you want a fixed password, also precreate a secret and reference it via admin.existingSecret.
  # Otherwise Keycloak generates a random one unless your chart template sets default; we’ll force via env below.

ports:
  http: 8080

service:
  type: ClusterIP
  httpPort: 80

proxy:
  enabled: true
  # mode: forwarded   # default; use xforwarded if you prefer:
# extraEnv supports KC_PROXY_HEADERS, so you can control exactly.

database:
  vendor: "postgres"
  host: "postgres"        # your Service name for Postgres
  port: 5432
  database: "keycloak"
  existingSecret:
    secretName: keycloak-db-creds
    userKey: username
    passwordKey: password

extraEnv:
  # Admin bootstrap (so you don’t rely on template’s secret generator)
  - name: KEYCLOAK_ADMIN
    value: "admin"
  - name: KEYCLOAK_ADMIN_PASSWORD
    value: "admin"

  # Use xforwarded if that’s what your ingress/proxy sends
  - name: KC_PROXY_HEADERS
    value: "xforwarded"

  # Serve under a relative path if you want (optional)
  - name: KC_HTTP_RELATIVE_PATH
    value: "/keycloak"

  # Realm import on startup (works because realm is baked into the image)
  # - name: KC_IMPORT
    # value: "/opt/keycloak/data/import/realm.json"
  - name: KC_IMPORT_STRATEGY
    value: "IGNORE_EXISTING"   # safe re-runs

  # Optional: discovery for cache clustering (single replica still ok)
  - name: JGROUPS_DISCOVERY_PROTOCOL
    value: "dns.DNS_PING"
  - name: JGROUPS_DISCOVERY_PROPERTIES
    value: "dns_query={{ .Release.Name }}-headless.default.svc.{{ .Values.clusterDomain | default \"cluster.local\" }}"
  - name: KC_CACHE
    value: "ispn"
  - name: KC_CACHE_STACK
    value: "kubernetes"

ingress:
  enabled: true
  className: traefik
  annotations:
    traefik.ingress.kubernetes.io/router.entrypoints: web,websecure
    cert-manager.io/cluster-issuer: letsencrypt
  rules:
    - host: hauth.test.poziomk3.pl
      paths:
        - path: /keycloak
          pathType: Prefix
  tls:
    - secretName: hauth-tls
      hosts:
        - hauth.test.poziomk3.pl

health:
  enabled: true
  startupProbe: |
    httpGet:
      path: /keycloak/health
      port: http
    initialDelaySeconds: 30
    timeoutSeconds: 1
    failureThreshold: 60
    periodSeconds: 5
  readinessProbe: |
    httpGet:
      path: /keycloak/health/ready
      port: http
    initialDelaySeconds: 30
    timeoutSeconds: 1
  livenessProbe: |
    httpGet:
      path: /keycloak/health/live
      port: http
    initialDelaySeconds: 0
    timeoutSeconds: 5